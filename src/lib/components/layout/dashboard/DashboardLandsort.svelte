<script lang="ts">
	import { activeMenu } from '$lib/stores.js';
	import { onMount } from 'svelte';
	import { apiFetch } from '$lib/api';
	import StatCard from './StatCard.svelte';

	// State for metrics
	let studentCount: number | null = null;
	let teacherCount: number | null = null;
	let classCount: number | null = null;
	let attendanceRate: number | null = null;

	let schoolName = 'Loading...';
	let loading = true;

	onMount(async () => {
		$activeMenu = 'dashboard';
		try {
			// 1. Fetch School Data
			const schoolRes = await apiFetch('/routes/api/schoolData');
			if (schoolRes.ok) {
				const data = await schoolRes.json();
				schoolName = data.name;
			}

			// 2. Fetch Student Count
			const studentRes = await apiFetch('/routes/api/studentDataSet/count');
			if (studentRes.ok) {
				const data = await studentRes.json();
				studentCount = data.count;
			}

			// 3. Fetch Teacher Count (Placeholder for now)
			teacherCount = 89;

			// 4. Fetch Class Count (Placeholder for now)
			classCount = 32;

			// 5. Fetch Attendance (Placeholder for now)
			attendanceRate = 92.5;
		} catch (err) {
			console.error('Dashboard fetch error:', err);
		} finally {
			loading = false;
		}
	});

	// Icons (SVG strings)
	const studentIcon =
		'<svg class="fill-blue-500" viewBox="0 0 32 32" height="32" width="32"><path fill="currentColor" d="M28.666933333333333 21.56693333333333v-8.399999999999999l-11.733333333333334 6.333333333333333c-0.3111333333333333 0.17779999999999999 -0.6333333333333333 0.26113333333333333 -0.9666666666666666 0.25 -0.3333333333333333 -0.011133333333333332 -0.6555333333333333 -0.10553333333333333 -0.9666666666666666 -0.2833333333333333l-12.066673333333334 -6.6c-0.17778 -0.11113333333333332 -0.30555333333333334 -0.2392 -0.3833333333333333 -0.3843333333333333 -0.07777999999999999 -0.14486666666666664 -0.11666666666666665 -0.306 -0.11666666666666665 -0.4833333333333333 0 -0.1771333333333333 0.03888666666666667 -0.33786666666666665 0.11666666666666665 -0.48233333333333334s0.2055533333333333 -0.2722 0.3833333333333333 -0.3833333333333333L15.000266666666665 4.533593333333333c0.15266666666666667 -0.08888666666666667 0.3095333333333333 -0.15555333333333332 0.4706666666666666 -0.19999999999999998 0.16113333333333332 -0.04444666666666666 0.3264666666666667 -0.06666666666666667 0.496 -0.06666666666666667 0.16953333333333334 0 0.33486666666666665 0.022219999999999997 0.496 0.06666666666666667 0.16113333333333332 0.04444666666666666 0.31799999999999995 0.11111333333333334 0.4706666666666666 0.19999999999999998l13.2 7.166673333333333c0.16933333333333334 0.0858 0.3005333333333333 0.2101333333333333 0.39366666666666666 0.373 0.09313333333333332 0.16266666666666665 0.13966666666666666 0.33833333333333326 0.13966666666666666 0.5269999999999999v8.966666666666665c0 0.2833333333333333 -0.09646666666666666 0.5207999999999999 -0.28933333333333333 0.7123333333333333 -0.19266666666666665 0.1918 -0.4315333333333333 0.2876666666666666 -0.7166666666666666 0.2876666666666666 -0.28486666666666666 0 -0.5217999999999999 -0.09586666666666667 -0.7106666666666667 -0.2876666666666666 -0.18886666666666665 -0.19153333333333333 -0.2833333333333333 -0.42899999999999994 -0.2833333333333333 -0.7123333333333333Zm-13.666666666666666 5.8999999999999995 -7.666666666666666 -4.199999999999999c-0.3111333333333333 -0.17779999999999999 -0.5611333333333333 -0.42499999999999993 -0.7500066666666667 -0.7416666666666667 -0.18888666666666667 -0.31666666666666665 -0.2833333333333333 -0.6583333333333333 -0.2833333333333333 -1.025v-5.799999999999999l8.700006666666667 4.766666666666667c0.3035333333333333 0.17779999999999999 0.6238666666666666 0.26666666666666666 0.961 0.26666666666666666s0.6612 -0.08886666666666666 0.9723333333333333 -0.26666666666666666l8.7 -4.766666666666667v5.799999999999999c0 0.3666666666666667 -0.09446666666666666 0.7083333333333333 -0.2833333333333333 1.025 -0.18886666666666665 0.31666666666666665 -0.4388666666666666 0.5638666666666666 -0.75 0.7416666666666667l-7.666666666666666 4.199999999999999c-0.15266666666666667 0.08886666666666666 -0.3095333333333333 0.15553333333333333 -0.4706666666666666 0.19999999999999998 -0.16113333333333332 0.04446666666666666 -0.3264666666666667 0.06666666666666667 -0.496 0.06666666666666667 -0.16953333333333334 0 -0.33486666666666665 -0.0222 -0.496 -0.06666666666666667 -0.16113333333333332 -0.04446666666666666 -0.31799999999999995 -0.11113333333333332 -0.4706666666666666 -0.19999999999999998Z" stroke-width="0.6667"></path></svg>';
	const teacherIcon =
		'<svg viewBox="0 0 32 32" fill="#000000" xmlns="http://www.w3.org/2000/svg" height="32" width="32">  <path d="M10.666666666666666 5.333333333333333c0 1.47276 -1.1939066666666664 2.6666666666666665 -2.6666666666666665 2.6666666666666665s-2.6666666666666665 -1.1939066666666664 -2.6666666666666665 -2.6666666666666665 1.1939066666666664 -2.6666666666666665 2.6666666666666665 -2.6666666666666665 2.6666666666666665 1.1939066666666664 2.6666666666666665 2.6666666666666665ZM6.666666666666666 21.333333333333332v8H4V13.333333333333332c0 -2.209133333333333 1.7908666666666666 -4 4 -4 1.09412 0 2.0856399999999997 0.43927999999999995 2.8078000000000003 1.1511066666666667l3.1659333333333333 2.9898266666666666 3.0837333333333334 -3.0837466666666664 1.8855999999999997 1.8856266666666666 -4.916266666666666 4.916253333333334L12 15.278266666666667V29.333333333333332H9.333333333333332v-8H6.666666666666666Zm6.666666666666666 -14.666666666666666h12v12h-12v2.6666666666666665h5.820533333333334l3.764666666666667 8h2.9471999999999996l-3.764666666666667 -8H26.666666666666664c0.7363999999999999 0 1.3333333333333333 -0.5969333333333333 1.3333333333333333 -1.3333333333333333V5.333333333333333c0 -0.7363733333333333 -0.5969333333333333 -1.3333333333333333 -1.3333333333333333 -1.3333333333333333H13.333333333333332v2.6666666666666665Z" stroke-width="1.3333"></path></svg>';
	const classIcon =
		'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 32 32" height="32" width="32"><g id="building-real-estate">    <path id="Union" fill="#000000" d="M9.125 3.7919866666666664c0.9234799999999999 -0.6541333333333332 2.1598533333333334 -0.6541333333333332 3.083333333333333 0l6.6666 4.72136c0.7057333333333333 0.49994666666666665 1.1250666666666667 1.3122133333333332 1.1250666666666667 2.17708V26.666933333333333h4.666666666666666v-2.1952c-1.9273333333333333 -0.5738666666666666 -3.3331999999999997 -2.357733333333333 -3.333333333333333 -4.471466666666666 0 -2.5773333333333333 2.0893333333333333 -4.666666666666666 4.666666666666666 -4.666666666666666s4.666666666666666 2.0893333333333333 4.666666666666666 4.666666666666666c-0.00013333333333333334 2.1137333333333332 -1.406 3.8975999999999997 -3.333333333333333 4.471466666666666v2.1952H29.333333333333332c0.7363999999999999 0 1.3333333333333333 0.5970666666666666 1.3333333333333333 1.3333333333333333 -0.00013333333333333334 0.7362666666666666 -0.5970666666666666 1.3333333333333333 -1.3333333333333333 1.3333333333333333H13.333333333333332c-0.7362799999999999 0 -1.3331733333333333 -0.5970666666666666 -1.3333333333333333 -1.3333333333333333v-4H9.333333333333332v4c-0.00014666666666666666 0.7362666666666666 -0.5970533333333333 1.3333333333333333 -1.3333333333333333 1.3333333333333333H2.6666666666666665c-0.7362799999999999 0 -1.3331733333333333 -0.5970666666666666 -1.3333333333333333 -1.3333333333333333V10.690426666666667c0 -0.8648666666666666 0.41928 -1.6771333333333331 1.125 -2.17708zM4 10.690426666666667V26.666933333333333h2.6666666666666665v-4c0 -0.7362666666666666 0.5969599999999999 -1.3333333333333333 1.3333333333333333 -1.3333333333333333h5.333333333333333c0.7363999999999999 0 1.3333333333333333 0.5970666666666666 1.3333333333333333 1.3333333333333333v4h2.6666666666666665V10.690426666666667L10.666666666666666 5.967773333333334zm9.333333333333332 5.3098399999999994c0.7363999999999999 0 1.3333333333333333 0.5970666666666666 1.3333333333333333 1.3333333333333333 -0.00013333333333333334 0.7362666666666666 -0.5970666666666666 1.3333333333333333 -1.3333333333333333 1.3333333333333333H8c-0.7362799999999999 0 -1.3331733333333333 -0.5970666666666666 -1.3333333333333333 -1.3333333333333333 0 -0.7362666666666666 0.5969599999999999 -1.3333333333333333 1.3333333333333333 -1.3333333333333333zm0 -5.33328c0.7363999999999999 0 1.3333333333333333 0.5969599999999999 1.3333333333333333 1.3333333333333333 -0.00013333333333333334 0.7362533333333332 -0.5970666666666666 1.3332799999999998 -1.3333333333333333 1.3332799999999998H8c-0.7362799999999999 0 -1.3331733333333333 -0.5970266666666666 -1.3333333333333333 -1.3332799999999998 0 -0.7363733333333333 0.5969599999999999 -1.3333333333333333 1.3333333333333333 -1.3333333333333333z" stroke-width="1.3333"></path></g></svg>';
	const attendanceIcon =
		'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 32 32" height="32" width="32"><g id="bar-chart">    <path id="Union" fill="#000000" d="M9.333333333333332 12c0.7363733333333333 0 1.3333333333333333 0.5969599999999999 1.3333333333333333 1.3333333333333333v12c0 0.7363999999999999 -0.5969599999999999 1.3333333333333333 -1.3333333333333333 1.3333333333333333H6.666666666666666c-0.7363733333333333 0 -1.3333333333333333 -0.5969333333333333 -1.3333333333333333 -1.3333333333333333v-12c0 -0.7363733333333333 0.5969599999999999 -1.3333333333333333 1.3333333333333333 -1.3333333333333333zm8 -6.666666666666666c0.7363999999999999 0 1.3333333333333333 0.5969599999999999 1.3333333333333333 1.3333333333333333v18.666666666666664c0 0.7363999999999999 -0.5969333333333333 1.3333333333333333 -1.3333333333333333 1.3333333333333333h-2.6666666666666665c-0.7363999999999999 0 -1.3333333333333333 -0.5969333333333333 -1.3333333333333333 -1.3333333333333333V6.666666666666666c0 -0.7363733333333333 0.5969333333333333 -1.3333333333333333 1.3333333333333333 -1.3333333333333333zm8 12c0.7363999999999999 0 1.3333333333333333 0.5969333333333333 1.3333333333333333 1.3333333333333333v6.666666666666666c0 0.7363999999999999 -0.5969333333333333 1.3333333333333333 -1.3333333333333333 1.3333333333333333h-2.6666666666666665c-0.7363999999999999 0 -1.3333333333333333 -0.5969333333333333 -1.3333333333333333 -1.3333333333333333v-6.666666666666666c0 -0.7363999999999999 0.5969333333333333 -1.3333333333333333 1.3333333333333333 -1.3333333333333333z" stroke-width="1.3333"></path></g></svg>';
</script>

<div class="bg w-full">
	<div class="mb-6">
		<h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
		<p class="mt-2 text-gray-600">Welcome to {schoolName} Education Platform</p>
	</div>

	<!-- Statistics Grid -->
	<div class="grid grid-cols-1 gap-6 p-6 md:grid-cols-2 lg:grid-cols-4">
		<!-- Card 1: Students -->
		<StatCard
			title="Total Students"
			value={studentCount}
			{loading}
			icon={studentIcon}
			iconBg="bg-blue-100"
			change={studentCount ? `${Math.round((studentCount / 100) * 100)}%` : null}
			changeColor="text-green-600"
		/>

		<!-- Card 2: Teachers -->
		<StatCard
			title="Total Teachers"
			value={teacherCount}
			{loading}
			icon={teacherIcon}
			iconBg="bg-purple-100"
			change="+5%"
			changeColor="text-green-600"
		/>

		<!-- Card 3: Classes -->
		<StatCard
			title="Total Classes"
			value={classCount}
			{loading}
			icon={classIcon}
			iconBg="bg-green-100"
			subtext="24 Active"
		/>

		<!-- Card 4: Attendance -->
		<StatCard
			title="Attendance Rate"
			value={attendanceRate ? `${attendanceRate}%` : null}
			{loading}
			icon={attendanceIcon}
			iconBg="bg-orange-100"
			change="92%"
			changeColor="text-green-600"
		/>
	</div>
</div>
