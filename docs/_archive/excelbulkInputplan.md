# Feature Plan: Bulk Student Input via Excel

This document outlines the plan for implementing a feature that allows administrators to add multiple students, including their parent and address data, by uploading a single Excel file.

## 1. Goal

To streamline the new student registration process by moving away from manual, one-by-one form entry and enabling bulk data import from a standardized Excel template.

## 2. The Excel Template

The core of this feature is a well-defined Excel template. It will be a "flat" file, meaning each row represents one student, with parent and address data included in the same row.

### Template Columns
The template will contain columns that map directly to the JSON payload structure.

**Student Columns:**
- `studentName`
- `nisn`
- `localNis`
- `gender` (e.g., "laki-laki" or "perempuan")
- `birthPlace`
- `birthDate` (Format: YYYY-MM-DD)
- `religion`
- ... (all other student fields)

**Address Columns (Prefixed):**
To avoid name collisions, we will prefix address columns.
- `address_street`
- `address_rt`
- `address_rw`
- `address_village`
- `address_province`
- ... (all other address fields)

**Parent Columns (Prefixed):**
Similarly, we will prefix columns for Father and Mother.
- `father_name`
- `father_nik`
- `father_job`
- `father_phone`
- `mother_name`
- `mother_nik`
- ... (all other parent fields)

## 3. Backend Implementation

### Step 1: Excel Generator Script (Optional but Recommended)
- **File:** `backend/testerAPI/generateStudentBulkTemplate.js`
- **Function:** Create a script that generates a blank `bulk_student_upload.xlsx` file with all the correct header columns. This helps users know exactly what format is expected.

### Step 2: New Service Function (`student.service.js`)
- **Function:** `createBulkStudentsFromExcel(fileBuffer)`
- **Logic:**
    1.  **Parse Excel:** Use `ExcelJS` to read the uploaded file buffer.
    2.  **Loop Rows:** Iterate through each row of the worksheet.
    3.  **Construct Payload:** For each row, dynamically build the nested JSON payload object that the `createStudentData` function already expects.
        ```javascript
        // Inside the loop for each row...
        const payload = {
            studentName: row.getCell('studentName').value,
            address: {
                street: row.getCell('address_street').value,
                // ...
            },
            father: {
                name: row.getCell('father_name').value,
                // ...
            },
            // ...
        };
        ```
    4.  **Transactional Insert:** Instead of calling `createStudentData` in a loop (which is inefficient and creates many separate transactions), we will wrap the entire loop in a **single, large transaction**.
        ```javascript
        await db.transaction(async (tx) => {
            for (const payload of allStudentPayloadsFromExcel) {
                // Insert student, then parents, using the 'tx' object
            }
        });
        ```
    5.  **Error Handling:** Keep track of which rows failed and why (e.g., "Duplicate NISN on row 5"), and return a summary of successes and failures.

### Step 3: New Controller & Route
- **Controller (`studentController.js`):** `uploadBulkStudents`
- **Route (`student.js`):** `POST /api/students/upload-bulk`
    - This route will use `multer` to handle the file upload and pass the `file.buffer` to the new service function.

## 4. Frontend UI

- **Location:** `(app)/siswa` (The main student list page).
- **Components:**
    1.  **Download Template Button:** A button that allows users to download the blank Excel template generated by the script in Step 1.
    2.  **Upload Button:** A button that opens a file dialog. On file selection, it will POST the file to the new `/api/students/upload-bulk` endpoint.
    3.  **Progress/Result Modal:** A pop-up that shows the result of the upload (e.g., "Successfully added 48 of 50 students. 2 failures: [details]").
